Решается динамическим программированием. Я в нём вообще ноль, поэтому до формулы сам не дошёл.
# TO DO:
Поботать динамическое программирование